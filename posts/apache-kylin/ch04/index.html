<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Kylin Cube 执行流程">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="Ch04-Kylin 之 Cube 构建流程" />
<meta property="og:description" content="Kylin Cube 执行流程" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://acronymor.com/posts/apache-kylin/ch04/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-17T00:00:00+08:00" />
<meta property="article:modified_time" content="2021-06-17T00:00:00+08:00" />
<title>Ch04-Kylin 之 Cube 构建流程 | acronymor&#39;s blog</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.c58292d36b18b675680ab9baea2029204537b839ea72f258746ec0f32ce8d6c8.css" integrity="sha256-xYKS02sYtnVoCrm66iApIEU3uDnqcvJYdG7A8yzo1sg=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.266b7315cee6128ee515dbe10e955a2a41087fa4b5cf1ca62e3a97d7b63e7674.js" integrity="sha256-JmtzFc7mEo7lFdvhDpVaKkEIf6S1zxymLjqX17Y&#43;dnQ=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?b8574e530940d019bc6fe14b11b86ab9";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>acronymor&#39;s blog</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  












  
<ul>
  
  <li>
    <a href="/posts/"  >
        Blog
      </a>
  </li>
  
  <li>
    <a href="/about/"  >
        About Me
      </a>
  </li>
  
  <li>
    <a href="https://github.com/acronymor"  target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Ch04-Kylin 之 Cube 构建流程</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#1-cube-构建调度流程">1. Cube 构建调度流程</a></li>
    <li><a href="#2-resourcedetectbeforecubingjob">2. ResourceDetectBeforeCubingJob</a>
      <ul>
        <li><a href="#22-文件目录">2.2 文件目录</a>
          <ul>
            <li><a href="#221-cubing_detect_itemsjson">2.2.1 cubing_detect_items.json</a></li>
            <li><a href="#222-resource_pathsjson">2.2.2 resource_paths.json</a></li>
            <li><a href="#223-count_distinctjson">2.2.3 count_distinct.json</a></li>
          </ul>
        </li>
        <li><a href="#23-spark-命令">2.3 Spark 命令</a></li>
      </ul>
    </li>
    <li><a href="#3-cubebuildjob">3. CubeBuildJob</a>
      <ul>
        <li><a href="#31-cube-初始化流程">3.1 Cube 初始化流程</a></li>
        <li><a href="#32-cuboid-构建流程">3.2 Cuboid 构建流程</a>
          <ul>
            <li><a href="#321-aggregationgroupinit">3.2.1 AggregationGroup#init()</a></li>
          </ul>
        </li>
        <li><a href="#33-segmentinfo-构建流程">3.3 SegmentInfo 构建流程</a>
          <ul>
            <li><a href="#331-extractallcolumndesccubeinstance">3.3.1 extractAllColumnDesc(cubeInstance)</a></li>
            <li><a href="#332-extractentityandmeasurescubeinstance">3.3.2 extractEntityAndMeasures(cubeInstance)</a></li>
          </ul>
        </li>
        <li><a href="#34-spanningtree">3.4 SpanningTree</a></li>
        <li><a href="#35-parentsourcechooser">3.5 ParentSourceChooser</a></li>
        <li><a href="#36-build">3.6 build</a>
          <ul>
            <li><a href="#361-buildcuboid">3.6.1 buildCuboid</a></li>
            <li><a href="#362-saveandupdatelayout">3.6.2 saveAndUpdateLayout</a></li>
          </ul>
        </li>
        <li><a href="#37-spark-命令">3.7 Spark 命令</a></li>
      </ul>
    </li>
    <li><a href="#4-参考文献">4. 参考文献</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
<article class="markdown">
  <h1>
    <a href="/posts/apache-kylin/ch04/">Ch04-Kylin 之 Cube 构建流程</a>
  </h1>
  
  <h5>June 17, 2021</h5>



  
  <div>
    
      <a href="/categories/Apache-Kylin/">Apache Kylin</a>
  </div>
  

  
  <div>
    
      <a href="/tags/kylin/">kylin</a>
  </div>
  



<p>Kylin Cube 执行流程</p>
<h1 id="1-cube-构建调度流程">
  1. Cube 构建调度流程
  <a class="anchor" href="#1-cube-%e6%9e%84%e5%bb%ba%e8%b0%83%e5%ba%a6%e6%b5%81%e7%a8%8b">#</a>
</h1>
<p>Cube 的构建流程如下所示：</p>
<p><img src="cube-all.png" alt="cube-all" /></p>
<p>NSparkCubingJob 中有个非常重要的方法<code>create</code>，该方法将构建 cube 的两个阶段<code>NResourceDetectStep</code>和<code>NSparkCubingStep</code>封装成 Job，并添加到了 kylin 维护的线程池中，依次执行。</p>
<blockquote>
<p>注意
上图中的<code>addTask()</code>和下图中的<code>getTasks()</code>这两个方法操作的是同一个 queue，因为<code>NSparkCubingJob</code>是<code>DefaultChainedExecutable</code>的子类，并且<code>NSparkCubingJob</code>并没有单独覆盖其方法。</p>
</blockquote>
<p><img src="execute-job.png" alt="execute-job" /></p>
<p>为了更加清晰的阐述这件事情，这里使用流程图来描述，如下图所示：</p>
<p><img src="cube-process.png" alt="cube-process" /></p>
<p>在项目启动的时候，会初始化一个定时线程池 (fetchPool)，接着该线程池又会添加一个定长 (<code>kylin.job.max-concurrent-jobs</code>) 的线程池 (jobPool)。jobPool 中可以执行多个<code>NSparkCubingJob</code>，每个<code>NSparkCubingJob</code>包含了<code>NResourceDetectStep</code>和<code>NSparkCubingStep</code>两个阶段。</p>
<p>至此，也就能够明白 cube 整体调度流程了，fetchPool 周期性调度 jobPool，jobPool 中如果有 job，那么就会被调起来执行。</p>
<h1 id="2-resourcedetectbeforecubingjob">
  2. ResourceDetectBeforeCubingJob
  <a class="anchor" href="#2-resourcedetectbeforecubingjob">#</a>
</h1>
<p>这一步的目的对 cube 的配置预处理，方便生成<code>cubing_detect_items.json</code>，<code>resource_paths.json</code>，<code>count_distinct.json</code>这三个文件，以供实际构建 cube 时使用。</p>
<p><img src="resource-detect-process.png" alt="resource-detect-process" /></p>
<h2 id="22-文件目录">
  2.2 文件目录
  <a class="anchor" href="#22-%e6%96%87%e4%bb%b6%e7%9b%ae%e5%bd%95">#</a>
</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>bin/hdfs dfs -ls /kylin/kylin_metadata/project_demo/job_tmp/5f824eb0-3124-4d02-a722-2ddaddd9eefd/share
</span></span><span style="display:flex;"><span>Found 3 items
</span></span><span style="display:flex;"><span>-rw-r--r--   1 li supergroup         12 2021-07-05 22:27 /kylin/kylin_metadata/project_demo/job_tmp/5f824eb0-3124-4d02-a722-2ddaddd9eefd/share/72023e32-05cd-9c65-c6d5-19f106f4dfbb_cubing_detect_items.json
</span></span><span style="display:flex;"><span>-rw-r--r--   1 li supergroup        133 2021-07-05 22:27 /kylin/kylin_metadata/project_demo/job_tmp/5f824eb0-3124-4d02-a722-2ddaddd9eefd/share/72023e32-05cd-9c65-c6d5-19f106f4dfbb_resource_paths.json
</span></span><span style="display:flex;"><span>-rw-r--r--   1 li supergroup          9 2021-07-05 22:27 /kylin/kylin_metadata/project_demo/job_tmp/5f824eb0-3124-4d02-a722-2ddaddd9eefd/share/count_distinct.json
</span></span></code></pre></div><h3 id="221-cubing_detect_itemsjson">
  2.2.1 cubing_detect_items.json
  <a class="anchor" href="#221-cubing_detect_itemsjson">#</a>
</h3>
<p>key 值是 layout id，value 是 task 总数（根据 rdd 的依赖关系统计而来）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;-1&#34;</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="222-resource_pathsjson">
  2.2.2 resource_paths.json
  <a class="anchor" href="#222-resource_pathsjson">#</a>
</h3>
<p>key 值是 layout id，value 是表数据地址</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;-1&#34;</span>: [
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;hdfs://localhost:9000/user/hive/warehouse/demo.db/t_student&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;hdfs://localhost:9000/user/hive/warehouse/demo.db/t_part&#34;</span>
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="223-count_distinctjson">
  2.2.3 count_distinct.json
  <a class="anchor" href="#223-count_distinctjson">#</a>
</h3>
<p>度量中是否有选择 count distinct</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#66d9ef">false</span>
</span></span></code></pre></div><h2 id="23-spark-命令">
  2.3 Spark 命令
  <a class="anchor" href="#23-spark-%e5%91%bd%e4%bb%a4">#</a>
</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#1 Step Name: Detect Resource</span>
</span></span><span style="display:flex;"><span>job.NSparkExecutable:377 : spark submit cmd:
</span></span><span style="display:flex;"><span>export HADOOP_CONF_DIR<span style="color:#f92672">=</span>/home/li/Software/apache-kylin-4.0.0-beta-bin/hadoop_conf <span style="color:#f92672">&amp;&amp;</span> /home/li/Software/apache-kylin-4.0.0-beta-bin/spark/bin/spark-submit
</span></span><span style="display:flex;"><span>--class org.apache.kylin.engine.spark.application.SparkEntry
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.yarn.queue=default&#39;</span>
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.history.fs.logDirectory=hdfs:///kylin/spark-history&#39;</span>
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.master=local&#39;</span>
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.hadoop.yarn.timeline-service.enabled=false&#39;</span>
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.driver.cores=1&#39;</span>
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.eventLog.enabled=true&#39;</span>
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.eventLog.dir=hdfs:///kylin/spark-history&#39;</span>
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.driver.memory=1G&#39;</span>
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.shuffle.service.enabled=true&#39;</span>
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.driver.extraJavaOptions=-Dlog4j.configuration=file:/home/li/Software/apache-kylin-4.0.0-beta-bin/conf/spark-driver-log4j.properties  -Dkylin.kerberos.enabled=false  -Dkylin.hdfs.working.dir=hdfs://localhost:9000/kylin/kylin_metadata/  -Dspark.driver.log4j.appender.hdfs.File=hdfs://localhost:9000/kylin/kylin_metadata/project_demo/spark_logs/driver/5f824eb0-3124-4d02-a722-2ddaddd9eefd-00/execute_output.json.1625495237514.log  -Dlog4j.debug=true  -Dspark.driver.rest.server.ip=127.0.1.1  -Dspark.driver.rest.server.port=7070  -Dspark.driver.param.taskId=5f824eb0-3124-4d02-a722-2ddaddd9eefd-00  -Dspark.driver.local.logDir=/home/li/Software/apache-kylin-4.0.0-beta-bin/logs/spark&#39;</span>
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.sql.autoBroadcastJoinThreshold=-1&#39;</span>
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.sql.adaptive.enabled=false&#39;</span>
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.driver.extraClassPath=/home/li/Software/apache-kylin-4.0.0-beta-bin/lib/kylin-parquet-job-4.0.0-beta.jar&#39;</span>
</span></span><span style="display:flex;"><span>--name job_step_5f824eb0-3124-4d02-a722-2ddaddd9eefd-00
</span></span><span style="display:flex;"><span>--jars /home/li/Software/apache-kylin-4.0.0-beta-bin/lib/kylin-parquet-job-4.0.0-beta.jar /home/li/Software/apache-kylin-4.0.0-beta-bin/lib/kylin-parquet-job-4.0.0-beta.jar -className
</span></span><span style="display:flex;"><span>-className org.apache.kylin.engine.spark.job.ResourceDetectBeforeCubingJob /home/li/Software/apache-kylin-4.0.0-beta-bin/tomcat/temp/segmentIds4550979510488136528
</span></span></code></pre></div><p><code>--conf 'spark.master=local'</code>这里很神奇的一点是，无论配置参数配成什么样，最后提交的时候都会被覆盖成 local 模式。</p>
<h1 id="3-cubebuildjob">
  3. CubeBuildJob
  <a class="anchor" href="#3-cubebuildjob">#</a>
</h1>
<p>Cube 的整体构建流程如下图所示。</p>
<p><img src="cube-build-process.png" alt="cube-build-process" /></p>
<p>整个流程看起来比较复杂，但是主要的流程如下：</p>
<ol>
<li>初始化 CubeInstance</li>
<li>从 CubeInstance 取出满足条件的 CubeSegment</li>
<li>通过 CubeInstance 和 CubeSegment 构造 SegmentInfo</li>
<li>将 SegmentInfo 中的所有 Cuboid 构造成生成树</li>
<li>构建大宽表</li>
<li>从该大宽表和生成树中构造 Cuboid</li>
<li>将构造出来的 Cuboid 写入到 HDFS 中</li>
<li>保存 SegmentInfo 的信息</li>
</ol>
<p>Cube 是逻辑上由 Cuboid 组成，在实际存储的时候，Cube 由 Segment 组成 (有多少个 build 任务就会有多少个 Segment)，Segment 又由 Cuboid 的实体 parquet 组成，因此 Cube 的构建，本质上就是构建若干 parquet 文件。</p>
<p>这里要说明下，在 Kylin 中，Cuboid 和 Segment 具体信息在系统启动初始化 Cube 的时候就初始化好了，上图中<code>getSegmentInfo</code>所做的工作只是从已经初始化好的 Cube 中提取相关信息罢了。</p>
<h2 id="31-cube-初始化流程">
  3.1 Cube 初始化流程
  <a class="anchor" href="#31-cube-%e5%88%9d%e5%a7%8b%e5%8c%96%e6%b5%81%e7%a8%8b">#</a>
</h2>
<p>Cube 的初始化流程如下图所示：</p>
<p><img src="cube-init.png" alt="cube-init" /></p>
<h2 id="32-cuboid-构建流程">
  3.2 Cuboid 构建流程
  <a class="anchor" href="#32-cuboid-%e6%9e%84%e5%bb%ba%e6%b5%81%e7%a8%8b">#</a>
</h2>
<h3 id="321-aggregationgroupinit">
  3.2.1 AggregationGroup#init()
  <a class="anchor" href="#321-aggregationgroupinit">#</a>
</h3>
<p>在生成 cuboidId 之前会先生成聚合组的 mask，其中用到了大量的移位和位或运算去生成 Mask。
AggregationGroup 在初始化时会生成所有包含维度、必须维度、联合维度、层级维度的 Mask</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AggregationGroup</span> <span style="color:#66d9ef">implements</span> Serializable <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span><span style="color:#f92672">(</span>CubeDesc cubeDesc<span style="color:#f92672">,</span> RowKeyDesc rowKeyDesc<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">cubeDesc</span> <span style="color:#f92672">=</span> cubeDesc<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isMandatoryOnlyValid</span> <span style="color:#f92672">=</span> cubeDesc<span style="color:#f92672">.</span><span style="color:#a6e22e">getConfig</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getCubeAggrGroupIsMandatoryOnlyValid</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">includes</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">includes</span><span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">selectRule</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IllegalStateException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;AggregationGroup incomplete&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        normalizeColumnNames<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 所有包含维度的 fullMask
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        buildPartialCubeFullMask<span style="color:#f92672">(</span>rowKeyDesc<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 强制维度
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        buildMandatoryColumnMask<span style="color:#f92672">(</span>rowKeyDesc<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 生成每组联合维度的 mask
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        buildJointColumnMask<span style="color:#f92672">(</span>rowKeyDesc<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 所有联合维度的 fullMask
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        buildJointDimsMask<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 每组层级维度的 mask
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        buildHierarchyMasks<span style="color:#f92672">(</span>rowKeyDesc<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 所有层级维度的 fullMask
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        buildHierarchyDimsMask<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 普通维度的掩码，不在强制、联合、层级维度中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        buildNormalDimsMask<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="33-segmentinfo-构建流程">
  3.3 SegmentInfo 构建流程
  <a class="anchor" href="#33-segmentinfo-%e6%9e%84%e5%bb%ba%e6%b5%81%e7%a8%8b">#</a>
</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">object</span> <span style="color:#a6e22e">MetadataConverter</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> getSegmentInfo<span style="color:#f92672">(</span>cubeInstance<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">CubeInstance</span><span style="color:#f92672">,</span> segmentId<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">,</span> segmentName<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">,</span> identifier<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">String</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">SegmentInfo</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> allColumnDesc <span style="color:#66d9ef">=</span> extractAllColumnDesc<span style="color:#f92672">(</span>cubeInstance<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 根据 cube 信息生成所有的 layout
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">val</span> <span style="color:#f92672">(</span>layoutEntities<span style="color:#f92672">,</span> measure<span style="color:#f92672">)</span> <span style="color:#66d9ef">=</span> extractEntityAndMeasures<span style="color:#f92672">(</span>cubeInstance<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 提取出 dataType 为 bitmap 的度量，count distinct 使用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">val</span> dictColumn <span style="color:#66d9ef">=</span> measure<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>filter<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>returnType<span style="color:#f92672">.</span>dataType<span style="color:#f92672">.</span>equals<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;bitmap&#34;</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">.</span>map<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>pra<span style="color:#f92672">.</span>head<span style="color:#f92672">).</span>toSet
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 根据获取到的信息，构造 SegmentInfo
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">SegmentInfo</span><span style="color:#f92672">(</span>segmentId<span style="color:#f92672">,</span> segmentName<span style="color:#f92672">,</span> identifier<span style="color:#f92672">,</span> cubeInstance<span style="color:#f92672">.</span>getProject<span style="color:#f92672">,</span> cubeInstance<span style="color:#f92672">.</span>getConfig<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 提取 factTableDesc
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      extractFactTable<span style="color:#f92672">(</span>cubeInstance<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 提取 lookupTables:List[TableDesc]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      extractLookupTable<span style="color:#f92672">(</span>cubeInstance<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 快照 snapshotTables
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      extractLookupTable<span style="color:#f92672">(</span>cubeInstance<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 表连接信息 joinDescs:Array[JoinDesc]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      extractJoinTable<span style="color:#f92672">(</span>cubeInstance<span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 所有字段信息，维度、度量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      allColumnDesc<span style="color:#f92672">.</span>asScala<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>toList<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// cube 层级信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      layoutEntities<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// cube 层级信息，toBuildLayouts
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      mutable<span style="color:#f92672">.</span><span style="color:#a6e22e">Set</span><span style="color:#f92672">[</span><span style="color:#66d9ef">LayoutEntity</span><span style="color:#f92672">](</span>layoutEntities<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">_</span><span style="color:#66d9ef">*</span><span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 字典列。returnType 为 bitmap 的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      dictColumn<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 字典列。returnType 为 bitmap 的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      dictColumn<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 分区信息，会把点 (.) 转为 0_DOT_0。如 TEST_KYLIN_FACT0_DOT_0CAL_DT &gt;= &#39;1970-01-
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">01</span><span style="color:#960050;background-color:#1e0010">&#39;</span> <span style="color:#a6e22e">AND</span> <span style="color:#a6e22e">TEST_KYLIN_FACT0_DOT_0CAL_DT</span> <span style="color:#f92672">&lt;</span> <span style="color:#960050;background-color:#1e0010">&#39;</span><span style="color:#ae81ff">2012</span><span style="color:#f92672">-</span><span style="color:#ae81ff">06</span><span style="color:#f92672">-</span><span style="color:#ae81ff">01</span><span style="color:#960050;background-color:#1e0010">&#39;</span>
</span></span><span style="display:flex;"><span>      extractPartitionExp<span style="color:#f92672">(</span>cubeInstance<span style="color:#f92672">.</span>getSegmentById<span style="color:#f92672">(</span>segmentId<span style="color:#f92672">)),</span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// 过滤条件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      extractFilterCondition<span style="color:#f92672">(</span>cubeInstance<span style="color:#f92672">.</span>getSegmentById<span style="color:#f92672">(</span>segmentId<span style="color:#f92672">)))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="331-extractallcolumndesccubeinstance">
  3.3.1 extractAllColumnDesc(cubeInstance)
  <a class="anchor" href="#331-extractallcolumndesccubeinstance">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> extractAllColumnDesc<span style="color:#f92672">(</span>cubeInstance<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">CubeInstance</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#66d9ef">java.util.LinkedHashMap</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Integer</span>, <span style="color:#66d9ef">ColumnDesc</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 存放所有列，key 是 index,value 是对应的列。最后返回的集合中包含所有的维度和度量 index
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">val</span> dimensionIndex <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> util<span style="color:#f92672">.</span><span style="color:#a6e22e">LinkedHashMap</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Integer</span>, <span style="color:#66d9ef">ColumnDesc</span><span style="color:#f92672">]()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 所有 rowkey，不包含衍生维度
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">val</span> columns <span style="color:#66d9ef">=</span> cubeInstance<span style="color:#f92672">.</span>getDescriptor
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span>getRowkey
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span>getRowKeyColumns
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 使用 bitIndex 作为 index，提取 rowKeyColumn
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">val</span> dimensionMapping <span style="color:#66d9ef">=</span> columns
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span>map<span style="color:#f92672">(</span>co <span style="color:#66d9ef">=&gt;</span> <span style="color:#f92672">(</span>co<span style="color:#f92672">.</span>getColRef<span style="color:#f92672">,</span> co<span style="color:#f92672">.</span>getBitIndex<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 单独提取出列的 ColRef 为 Set 集合
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">val</span> set <span style="color:#66d9ef">=</span> dimensionMapping<span style="color:#f92672">.</span>map<span style="color:#f92672">(</span><span style="color:#66d9ef">_</span><span style="color:#f92672">.</span>_1<span style="color:#f92672">).</span>toSet
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 1. 获取所有字段，维度 + 度量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// 2. 和 Rowkeys 取差集，相当于提取出度量列、衍生维度列，然后使用 zipWithIndex 自动生成序号
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">// 3. 为了避免与维度列的 index 混淆，index 加上所有维度的数量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">val</span> refs <span style="color:#66d9ef">=</span> cubeInstance<span style="color:#f92672">.</span>getAllColumns<span style="color:#f92672">.</span>asScala<span style="color:#f92672">.</span>diff<span style="color:#f92672">(</span>set<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span>zipWithIndex
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span>map<span style="color:#f92672">(</span>tp <span style="color:#66d9ef">=&gt;</span> <span style="color:#f92672">(</span>tp<span style="color:#f92672">.</span>_1<span style="color:#f92672">,</span> tp<span style="color:#f92672">.</span>_2 <span style="color:#f92672">+</span> dimensionMapping<span style="color:#f92672">.</span>length<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// 将维度和度量列统一方放入 dimensionIndex map 中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">val</span> columnIDTuples <span style="color:#66d9ef">=</span> dimensionMapping <span style="color:#f92672">++</span> refs
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">val</span> colToIndex <span style="color:#66d9ef">=</span> columnIDTuples<span style="color:#f92672">.</span>toMap
</span></span><span style="display:flex;"><span>  columnIDTuples
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span>foreach <span style="color:#f92672">{</span> co <span style="color:#66d9ef">=&gt;</span>
</span></span><span style="display:flex;"><span>      dimensionIndex<span style="color:#f92672">.</span>put<span style="color:#f92672">(</span>co<span style="color:#f92672">.</span>_2<span style="color:#f92672">,</span> toColumnDesc<span style="color:#f92672">(</span>co<span style="color:#f92672">.</span>_1<span style="color:#f92672">,</span> co<span style="color:#f92672">.</span>_2<span style="color:#f92672">,</span> set<span style="color:#f92672">.</span>contains<span style="color:#f92672">(</span>co<span style="color:#f92672">.</span>_1<span style="color:#f92672">)))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  dimensionIndex
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="332-extractentityandmeasurescubeinstance">
  3.3.2 extractEntityAndMeasures(cubeInstance)
  <a class="anchor" href="#332-extractentityandmeasurescubeinstance">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> extractEntityAndMeasures<span style="color:#f92672">(</span>cubeInstance<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">CubeInstance</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">List</span><span style="color:#f92672">[</span><span style="color:#66d9ef">LayoutEntity</span><span style="color:#f92672">],</span> <span style="color:#a6e22e">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Integer</span>, <span style="color:#66d9ef">FunctionDesc</span><span style="color:#f92672">])</span> <span style="color:#66d9ef">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 获取所有的列 index 信息，根据 bitIndex 生成
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">val</span> <span style="color:#f92672">(</span>columnIndexes<span style="color:#f92672">,</span> shardByColumnsId<span style="color:#f92672">,</span> idToColumnMap<span style="color:#f92672">,</span> measureId<span style="color:#f92672">)</span> <span style="color:#66d9ef">=</span> genIDToColumnMap<span style="color:#f92672">(</span>cubeInstance<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">(</span>cubeInstance<span style="color:#f92672">.</span>getCuboidScheduler
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">.</span>getAllCuboidIds   <span style="color:#75715e">// 获取所有 cuboidId，根据 cuboidId 生成 layouts
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#f92672">.</span>asScala
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">.</span>map <span style="color:#f92672">{</span> long <span style="color:#66d9ef">=&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 遍历每个 cuboidId，生成 layoutEntity
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        genLayoutEntity<span style="color:#f92672">(</span>columnIndexes<span style="color:#f92672">,</span> shardByColumnsId<span style="color:#f92672">,</span> idToColumnMap<span style="color:#f92672">,</span> measureId<span style="color:#f92672">,</span> long<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}.</span>toList<span style="color:#f92672">,</span> measureId<span style="color:#f92672">.</span>asScala<span style="color:#f92672">.</span>toMap<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">def</span> genIDToColumnMap<span style="color:#f92672">(</span>cubeInstance<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">CubeInstance</span><span style="color:#f92672">)</span><span style="color:#66d9ef">:</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">List</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Integer</span><span style="color:#f92672">],</span> <span style="color:#a6e22e">List</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Integer</span><span style="color:#f92672">],</span> java<span style="color:#f92672">.</span>util<span style="color:#f92672">.</span><span style="color:#a6e22e">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Integer</span>, <span style="color:#66d9ef">ColumnDesc</span><span style="color:#f92672">],</span> java<span style="color:#f92672">.</span>util<span style="color:#f92672">.</span><span style="color:#a6e22e">Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Integer</span>, <span style="color:#66d9ef">FunctionDesc</span><span style="color:#f92672">])</span> <span style="color:#66d9ef">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">val</span> dimensionIndex <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> util<span style="color:#f92672">.</span><span style="color:#a6e22e">LinkedHashMap</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Integer</span>, <span style="color:#66d9ef">ColumnDesc</span><span style="color:#f92672">]()</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">val</span> shardByColumnsId <span style="color:#66d9ef">=</span> shardByColumns<span style="color:#f92672">.</span>asScala<span style="color:#f92672">.</span>toList
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">.</span>map<span style="color:#f92672">(</span>column <span style="color:#66d9ef">=&gt;</span> dimensionMap<span style="color:#f92672">.</span>get<span style="color:#f92672">(</span>column<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">.</span>filter<span style="color:#f92672">(</span>v <span style="color:#66d9ef">=&gt;</span> v <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">.</span>map<span style="color:#f92672">(</span>column <span style="color:#66d9ef">=&gt;</span> <span style="color:#a6e22e">Integer</span><span style="color:#f92672">.</span>valueOf<span style="color:#f92672">(</span>column<span style="color:#f92672">.</span>get<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">val</span> idToColumnMap <span style="color:#66d9ef">=</span> dimensionMapping<span style="color:#f92672">.</span>map<span style="color:#f92672">(</span>tp <span style="color:#66d9ef">=&gt;</span> <span style="color:#a6e22e">Integer</span><span style="color:#f92672">.</span>valueOf<span style="color:#f92672">(</span>tp<span style="color:#f92672">.</span>_2<span style="color:#f92672">)).</span>toList
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">val</span> measureIndex <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> util<span style="color:#f92672">.</span><span style="color:#a6e22e">LinkedHashMap</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Integer</span>, <span style="color:#66d9ef">FunctionDesc</span><span style="color:#f92672">]()</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">(</span>idToColumnMap<span style="color:#f92672">,</span> shardByColumnsId<span style="color:#f92672">,</span> dimensionIndex<span style="color:#f92672">,</span> measureIndex<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">def</span> genLayoutEntity<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>        columnIndexes<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">List</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Integer</span><span style="color:#f92672">],</span> shardByColumnsId<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">List</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Integer</span><span style="color:#f92672">],</span> idToColumnMap<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">java.util.Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Integer</span>, <span style="color:#66d9ef">ColumnDesc</span><span style="color:#f92672">],</span>
</span></span><span style="display:flex;"><span>        measureId<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">java.util.Map</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Integer</span>, <span style="color:#66d9ef">FunctionDesc</span><span style="color:#f92672">],</span> long<span style="color:#66d9ef">:</span> <span style="color:#66d9ef">lang.Long</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 根据 cuboidId 计算出该 cuboid 包含的哪些维度
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">val</span> dimension <span style="color:#66d9ef">=</span> <span style="color:#a6e22e">BitUtils</span><span style="color:#f92672">.</span>tailor<span style="color:#f92672">(</span>columnIndexes<span style="color:#f92672">.</span>asJava<span style="color:#f92672">,</span> long<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 存放维度的 bitIndex
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">val</span> integerToDesc <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> util<span style="color:#f92672">.</span><span style="color:#a6e22e">LinkedHashMap</span><span style="color:#f92672">[</span><span style="color:#66d9ef">Integer</span>, <span style="color:#66d9ef">ColumnDesc</span><span style="color:#f92672">]()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 把 cuboid 的维度信息放入 map 中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    dimension<span style="color:#f92672">.</span>asScala<span style="color:#f92672">.</span>foreach<span style="color:#f92672">(</span>index <span style="color:#66d9ef">=&gt;</span> integerToDesc<span style="color:#f92672">.</span>put<span style="color:#f92672">(</span>index<span style="color:#f92672">,</span> idToColumnMap<span style="color:#f92672">.</span>get<span style="color:#f92672">(</span>index<span style="color:#f92672">)))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> entity <span style="color:#66d9ef">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">LayoutEntity</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    entity<span style="color:#f92672">.</span>setId<span style="color:#f92672">(</span>long<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    entity<span style="color:#f92672">.</span>setOrderedDimensions<span style="color:#f92672">(</span>integerToDesc<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    entity<span style="color:#f92672">.</span>setOrderedMeasures<span style="color:#f92672">(</span>measureId<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">val</span> shards <span style="color:#66d9ef">=</span> shardByColumnsId<span style="color:#f92672">.</span>filter<span style="color:#f92672">(</span>column <span style="color:#66d9ef">=&gt;</span> dimension<span style="color:#f92672">.</span>contains<span style="color:#f92672">(</span>column<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>    entity<span style="color:#f92672">.</span>setShardByColumns<span style="color:#f92672">(</span>shards<span style="color:#f92672">.</span>asJava<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    entity
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="34-spanningtree">
  3.4 SpanningTree
  <a class="anchor" href="#34-spanningtree">#</a>
</h2>
<p>在 SegmentInfo 中的会生成 toBuildLayouts，但是这些 layoutEntities 是无序的，但是在 Cube 中这些 layout 是具有父子级关系的，例如 ABCD-&gt;ABC-&gt;AB，那么就需要有一个数据结构来生成并保存这种顺序。
在 ForestSpanningTree 中会先将传入的 layoutEntities 进行排序，排序的优先级为<code>维度数-&gt;度量数-&gt;cuboidId</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String segId <span style="color:#f92672">:</span> segmentIds<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        seg <span style="color:#f92672">=</span> ManagerHub<span style="color:#f92672">.</span><span style="color:#a6e22e">getSegmentInfo</span><span style="color:#f92672">(</span>config<span style="color:#f92672">,</span> cubeName<span style="color:#f92672">,</span> segId<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        spanningTree <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ForestSpanningTree<span style="color:#f92672">(</span>JavaConversions<span style="color:#f92672">.</span><span style="color:#a6e22e">asJavaCollection</span><span style="color:#f92672">(</span>seg<span style="color:#f92672">.</span><span style="color:#a6e22e">toBuildLayouts</span><span style="color:#f92672">()));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="35-parentsourcechooser">
  3.5 ParentSourceChooser
  <a class="anchor" href="#35-parentsourcechooser">#</a>
</h2>
<p><code>ParentSourceChooser</code>是整个构建 cube 的逻辑中最复杂的一部分，这里依次完成了大宽表，SnapShot 等的构建。</p>
<p><img src="decide-sources.png" alt="decide-sources" /></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>String segId <span style="color:#f92672">:</span> segmentIds<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        sourceChooser <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ParentSourceChooser<span style="color:#f92672">(</span>spanningTree<span style="color:#f92672">,</span> seg<span style="color:#f92672">,</span> jobId<span style="color:#f92672">,</span> ss<span style="color:#f92672">,</span> config<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        sourceChooser<span style="color:#f92672">.</span><span style="color:#a6e22e">decideSources</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        NBuildSourceInfo buildFromFlatTable <span style="color:#f92672">=</span> sourceChooser<span style="color:#f92672">.</span><span style="color:#a6e22e">flatTableSource</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        Map<span style="color:#f92672">&lt;</span>Long<span style="color:#f92672">,</span> NBuildSourceInfo<span style="color:#f92672">&gt;</span> buildFromLayouts <span style="color:#f92672">=</span> sourceChooser<span style="color:#f92672">.</span><span style="color:#a6e22e">reuseSources</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// String flatTablePath = sourceChooser.persistFlatTableIfNecessary();
</span></span></span></code></pre></div><h2 id="36-build">
  3.6 build
  <a class="anchor" href="#36-build">#</a>
</h2>
<p>层级构建会基于上面生成的宽表进行构建，优先构建 baseCuboid</p>
<h3 id="361-buildcuboid">
  3.6.1 buildCuboid
  <a class="anchor" href="#361-buildcuboid">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#75715e">// 按照 rowkeys(维度) 的顺序进行分区排序
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Dataset<span style="color:#f92672">&lt;</span>Row<span style="color:#f92672">&gt;</span> afterSort <span style="color:#f92672">=</span> afterAgg
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">select</span><span style="color:#f92672">(</span>NSparkCubingUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">getColumns</span><span style="color:#f92672">(</span>rowKeys<span style="color:#f92672">,</span> layoutEntity<span style="color:#f92672">.</span><span style="color:#a6e22e">getOrderedMeasures</span><span style="color:#f92672">().</span><span style="color:#a6e22e">keySet</span><span style="color:#f92672">()))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">sortWithinPartitions</span><span style="color:#f92672">(</span>NSparkCubingUtil<span style="color:#f92672">.</span><span style="color:#a6e22e">getColumns</span><span style="color:#f92672">(</span>rowKeys<span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    saveAndUpdateLayout<span style="color:#f92672">(</span>afterSort<span style="color:#f92672">,</span> seg<span style="color:#f92672">,</span> layoutEntity<span style="color:#f92672">,</span> parentId<span style="color:#f92672">);</span>
</span></span></code></pre></div><h3 id="362-saveandupdatelayout">
  3.6.2 saveAndUpdateLayout
  <a class="anchor" href="#362-saveandupdatelayout">#</a>
</h3>
<p>将结果保存到 temp 目录</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    String tempPath <span style="color:#f92672">=</span> path <span style="color:#f92672">+</span> TEMP_DIR_SUFFIX<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// save to temp path
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    logger<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Cuboids are saved to temp path : &#34;</span> <span style="color:#f92672">+</span> tempPath<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    storage<span style="color:#f92672">.</span><span style="color:#a6e22e">saveTo</span><span style="color:#f92672">(</span>tempPath<span style="color:#f92672">,</span> dataset<span style="color:#f92672">,</span> ss<span style="color:#f92672">);</span>
</span></span></code></pre></div><p>将结果重分区，然后写入到最终的 path 下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#75715e">// 进行重分区，默认会按文件大小 (128M)，行数 (2500000，如果存在 count distinct 则是 1000000), 将结果重分区写到 path 路径下
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">int</span> shardNum <span style="color:#f92672">=</span> BuildUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">repartitionIfNeed</span><span style="color:#f92672">(</span>layout<span style="color:#f92672">,</span> storage<span style="color:#f92672">,</span> path<span style="color:#f92672">,</span> tempPath<span style="color:#f92672">,</span> cubeInstance<span style="color:#f92672">.</span><span style="color:#a6e22e">getConfig</span><span style="color:#f92672">(),</span> ss<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    layout<span style="color:#f92672">.</span><span style="color:#a6e22e">setShardNum</span><span style="color:#f92672">(</span>shardNum<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    cuboidShardNum<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span>layoutId<span style="color:#f92672">,</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">short</span><span style="color:#f92672">)</span> shardNum<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    ss<span style="color:#f92672">.</span><span style="color:#a6e22e">sparkContext</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setLocalProperty</span><span style="color:#f92672">(</span>QueryExecutionCache<span style="color:#f92672">.</span><span style="color:#a6e22e">N_EXECUTION_ID_KEY</span><span style="color:#f92672">(),</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    QueryExecutionCache<span style="color:#f92672">.</span><span style="color:#a6e22e">removeQueryExecution</span><span style="color:#f92672">(</span>queryExecutionId<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 记录文件数量，文件大小
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    BuildUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">fillCuboidInfo</span><span style="color:#f92672">(</span>layout<span style="color:#f92672">,</span> path<span style="color:#f92672">);</span>
</span></span></code></pre></div><h2 id="37-spark-命令">
  3.7 Spark 命令
  <a class="anchor" href="#37-spark-%e5%91%bd%e4%bb%a4">#</a>
</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#2 Step Name: Build Cube with Spark</span>
</span></span><span style="display:flex;"><span>job.NSparkExecutable:377 : spark submit cmd:
</span></span><span style="display:flex;"><span>export HADOOP_CONF_DIR<span style="color:#f92672">=</span>/home/li/Software/apache-kylin-4.0.0-beta-bin/hadoop_conf <span style="color:#f92672">&amp;&amp;</span> /home/li/Software/apache-kylin-4.0.0-beta-bin/spark/bin/spark-submit
</span></span><span style="display:flex;"><span>--class org.apache.kylin.engine.spark.application.SparkEntry
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.yarn.queue=default&#39;</span>
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.history.fs.logDirectory=hdfs:///kylin/spark-history&#39;</span>
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.master=yarn&#39;</span>
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.hadoop.yarn.timeline-service.enabled=false&#39;</span>
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.driver.cores=1&#39;</span>
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.eventLog.enabled=true&#39;</span>
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.eventLog.dir=hdfs:///kylin/spark-history&#39;</span>
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.driver.memory=1G&#39;</span>
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.shuffle.service.enabled=true&#39;</span>
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.driver.extraJavaOptions=-Dlog4j.configuration=file:/home/li/Software/apache-kylin-4.0.0-beta-bin/conf/spark-driver-log4j.properties  -Dkylin.kerberos.enabled=false  -Dkylin.hdfs.working.dir=hdfs://localhost:9000/kylin/kylin_metadata/  -Dspark.driver.log4j.appender.hdfs.File=hdfs://localhost:9000/kylin/kylin_metadata/project_demo/spark_logs/driver/caecf214-ec24-4f30-baa0-9a242719e108-01/execute_output.json.1625311763246.log  -Dlog4j.debug=true  -Dspark.driver.rest.server.ip=127.0.1.1  -Dspark.driver.rest.server.port=7070  -Dspark.driver.param.taskId=caecf214-ec24-4f30-baa0-9a242719e108-01  -Dspark.driver.local.logDir=/home/li/Software/apache-kylin-4.0.0-beta-bin/logs/spark&#39;</span>
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.executor.extraJavaOptions=-Dfile.encoding=UTF-8 -Dhdp.version=current -Dlog4j.configuration=spark-executor-log4j.properties -Dlog4j.debug -Dkylin.hdfs.working.dir=hdfs://localhost:9000/kylin/kylin_metadata/ -Dkylin.metadata.identifier=kylin_metadata -Dkylin.spark.category=job -Dkylin.spark.project=project_demo -Dkylin.spark.identifier=5f824eb0-3124-4d02-a722-2ddaddd9eefd -Dkylin.spark.jobName=5f824eb0-3124-4d02-a722-2ddaddd9eefd-01 -Duser.timezone=Asia/Shanghai&#39;</span>
</span></span><span style="display:flex;"><span>--conf <span style="color:#e6db74">&#39;spark.driver.extraClassPath=/home/li/Software/apache-kylin-4.0.0-beta-bin/lib/kylin-parquet-job-4.0.0-beta.jar&#39;</span>
</span></span><span style="display:flex;"><span>--files /home/li/Software/apache-kylin-4.0.0-beta-bin/conf/spark-executor-log4j.properties
</span></span><span style="display:flex;"><span>--name job_step_caecf214-ec24-4f30-baa0-9a242719e108-01
</span></span><span style="display:flex;"><span>--jars /home/li/Software/apache-kylin-4.0.0-beta-bin/lib/kylin-parquet-job-4.0.0-beta.jar /home/li/Software/apache-kylin-4.0.0-beta-bin/lib/kylin-parquet-job-4.0.0-beta.jar -className
</span></span><span style="display:flex;"><span>-className org.apache.kylin.engine.spark.job.CubeBuildJob /home/li/Software/apache-kylin-4.0.0-beta-bin/tomcat/temp/segmentIds4902579912004494679
</span></span></code></pre></div><h1 id="4-参考文献">
  4. 参考文献
  <a class="anchor" href="#4-%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae">#</a>
</h1>
<ul>
<li><a href="https://mp.weixin.qq.com/s/Ro0ebqHxQ7mALzC2h_jYKA">Kylin on Parquet</a></li>
<li><a href="https://blog.lovedata.net/b6c1ac95.html">Kylin 源码解析-kylin 构建流程总览</a></li>
<li><a href="https://blog.lovedata.net/37750c96.html">Kylin 源码解析 - 构建层级分析</a></li>
<li><a href="https://juejin.cn/post/6844903701799239688">Kylin 官方案例详细剖析及剪枝优化-OLAP 商业环境实战</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/355154549">Kylin 如何实现基数统计</a></li>
</ul></article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#1-cube-构建调度流程">1. Cube 构建调度流程</a></li>
    <li><a href="#2-resourcedetectbeforecubingjob">2. ResourceDetectBeforeCubingJob</a>
      <ul>
        <li><a href="#22-文件目录">2.2 文件目录</a>
          <ul>
            <li><a href="#221-cubing_detect_itemsjson">2.2.1 cubing_detect_items.json</a></li>
            <li><a href="#222-resource_pathsjson">2.2.2 resource_paths.json</a></li>
            <li><a href="#223-count_distinctjson">2.2.3 count_distinct.json</a></li>
          </ul>
        </li>
        <li><a href="#23-spark-命令">2.3 Spark 命令</a></li>
      </ul>
    </li>
    <li><a href="#3-cubebuildjob">3. CubeBuildJob</a>
      <ul>
        <li><a href="#31-cube-初始化流程">3.1 Cube 初始化流程</a></li>
        <li><a href="#32-cuboid-构建流程">3.2 Cuboid 构建流程</a>
          <ul>
            <li><a href="#321-aggregationgroupinit">3.2.1 AggregationGroup#init()</a></li>
          </ul>
        </li>
        <li><a href="#33-segmentinfo-构建流程">3.3 SegmentInfo 构建流程</a>
          <ul>
            <li><a href="#331-extractallcolumndesccubeinstance">3.3.1 extractAllColumnDesc(cubeInstance)</a></li>
            <li><a href="#332-extractentityandmeasurescubeinstance">3.3.2 extractEntityAndMeasures(cubeInstance)</a></li>
          </ul>
        </li>
        <li><a href="#34-spanningtree">3.4 SpanningTree</a></li>
        <li><a href="#35-parentsourcechooser">3.5 ParentSourceChooser</a></li>
        <li><a href="#36-build">3.6 build</a>
          <ul>
            <li><a href="#361-buildcuboid">3.6.1 buildCuboid</a></li>
            <li><a href="#362-saveandupdatelayout">3.6.2 saveAndUpdateLayout</a></li>
          </ul>
        </li>
        <li><a href="#37-spark-命令">3.7 Spark 命令</a></li>
      </ul>
    </li>
    <li><a href="#4-参考文献">4. 参考文献</a></li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












